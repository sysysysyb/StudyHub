name: Discord Notifications

on:
  pull_request:
    types: [opened, review_requested, closed]
  pull_request_review:
    types: [submitted]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      # PR ìƒì„± ì•Œë¦¼
      - name: Notify on PR Opened
        if: github.event.action == 'opened'
        run: |
          curl -H "Content-Type: application/json" \
              -X POST \
              -d '{
                "embeds": [{
                  "title": "ğŸ†• ìƒˆë¡œìš´ PRì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!",
                  "description": "[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})",
                  "color": 3447003,
                  "fields": [
                    {
                      "name": "ğŸ‘¤ ì‘ì„±ì",
                      "value": "${{ github.event.pull_request.user.login }}",
                      "inline": true
                    },
                    {
                      "name": "ğŸŒ¿ ë¸Œëœì¹˜",
                      "value": "`${{ github.event.pull_request.head.ref }}` â†’ `${{ github.event.pull_request.base.ref }}`",
                      "inline": true
                    },
                    {
                      "name": "ğŸ“Š ë³€ê²½ì‚¬í•­",
                      "value": "+${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}",
                      "inline": true
                    }
                  ],
                  "timestamp": "${{ github.event.pull_request.created_at }}"
                }]
              }' \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ì—¬ëŸ¬ ë¦¬ë·°ì–´ ë©˜ì…˜ (ì¤‘ë³µ ë°©ì§€ ë²„ì „)
      - name: Mention Reviewers
        if: github.event.action == 'review_requested'
        run: |
          # í˜„ì¬ ë¦¬ë·°ì–´ê°€ ì²« ë²ˆì§¸ ë¦¬ë·°ì–´ì¸ì§€ í™•ì¸ (ì¤‘ë³µ ë°©ì§€)
          REVIEWERS_JSON='${{ toJSON(github.event.pull_request.requested_reviewers) }}'
          FIRST_REVIEWER=$(echo "$REVIEWERS_JSON" | jq -r '.[0].login // empty')
          CURRENT_REVIEWER="${{ github.event.requested_reviewer.login }}"

          echo "í˜„ì¬ ë¦¬ë·°ì–´: $CURRENT_REVIEWER"
          echo "ì²« ë²ˆì§¸ ë¦¬ë·°ì–´: $FIRST_REVIEWER"

          # ì²« ë²ˆì§¸ ë¦¬ë·°ì–´ì´ê±°ë‚˜ ë¦¬ë·°ì–´ê°€ í•œ ëª…ì¼ ë•Œë§Œ ì‹¤í–‰
          if [ "$CURRENT_REVIEWER" = "$FIRST_REVIEWER" ] || [ -z "$FIRST_REVIEWER" ]; then
            echo "ì•Œë¦¼ ì „ì†¡ ì‹œì‘..."
            
            # ê° ë¦¬ë·°ì–´ì˜ login ê°’ì„ ì¶”ì¶œí•˜ì—¬ ë©˜ì…˜ ë¬¸ìì—´ ìƒì„±
            MENTIONS=""
            for login in $(echo "$REVIEWERS_JSON" | jq -r '.[] | .login'); do
              case "$login" in
                "chen4023")
                  MENTIONS="$MENTIONS <@683563560063991848>"
                  ;;
                "Kwonyeojiny")
                  MENTIONS="$MENTIONS <@579296258091646976>"
                  ;;
                "shin-minhyuk")
                  MENTIONS="$MENTIONS <@1121074841102069814>"
                  ;;
                "sysysysyb")
                  MENTIONS="$MENTIONS <@950597490086924368>"
                  ;;
                 "dirage1")
                  MENTIONS="$MENTIONS <@1128168230540804258>"
                  ;;
                 "Jaeeun0723")
                  MENTIONS="$MENTIONS <@478568545748254720>"
                  ;;
                 "JaeHyunLee123")
                  MENTIONS="$MENTIONS <@338615685498273792>"
                  ;;
                *)
                  MENTIONS="$MENTIONS @$login"
                  ;;
              esac
            done

            # ë§Œì•½ ìš”ì²­ëœ ë¦¬ë·°ì–´ê°€ ì—†ìœ¼ë©´ í˜„ì¬ ë¦¬ë·°ì–´ë¡œ ëŒ€ì²´
            if [ -z "$MENTIONS" ]; then
              case "$CURRENT_REVIEWER" in
                "chen4023") MENTIONS="<@683563560063991848>" ;;
                "Kwonyeojiny") MENTIONS="<@579296258091646976>" ;;
                "shin-minhyuk") MENTIONS="<@1121074841102069814>" ;;
                "sysysysyb") MENTIONS="<@950597490086924368>" ;;
                "dirage1") MENTIONS="<@1128168230540804258>" ;;
                "Jaeeun0723") MENTIONS="<@478568545748254720>" ;;
                "JaeHyunLee123") MENTIONS="<@338615685498273792>" ;;
                *) MENTIONS="@$CURRENT_REVIEWER" ;;
              esac
            fi

            # ì•ˆì „í•œ JSON ìƒì„±
            curl -H "Content-Type: application/json" \
                 -X POST \
                 -d "{
                   \"content\": \"ğŸ” **ë¦¬ë·° ìš”ì²­ì´ ë„ì°©í–ˆìŠµë‹ˆë‹¤!** $MENTIONS\",
                   \"embeds\": [{
                     \"title\": \"ë¦¬ë·°ë¥¼ ë¶€íƒë“œë¦½ë‹ˆë‹¤! ğŸ‘€\",
                     \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                     \"color\": 16776960,
                     \"fields\": [
                       {
                         \"name\": \"ğŸ‘¤ PR ì‘ì„±ì\",
                         \"value\": \"${{ github.event.pull_request.user.login }}\",
                         \"inline\": true
                       },
                       {
                         \"name\": \"ğŸ“ ë³€ê²½ì‚¬í•­\",
                         \"value\": \"íŒŒì¼ ${{ github.event.pull_request.changed_files }}ê°œ | +${{ github.event.pull_request.additions }} -${{ github.event.pull_request.deletions }}\",
                         \"inline\": false
                       }
                     ]
                   }]
                 }" \
                 ${{ secrets.DISCORD_WEBHOOK_URL }}
          else
            echo "ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€: ì´ë¯¸ ì²« ë²ˆì§¸ ë¦¬ë·°ì–´ê°€ ì•Œë¦¼ì„ ì „ì†¡í–ˆìŠµë‹ˆë‹¤."
          fi

      # PR ë³‘í•©/ë‹«í˜ ì•Œë¦¼
      - name: Notify on PR Closed
        if: github.event.action == 'closed'
        run: |
          if [ "${{ github.event.pull_request.merged }}" == "true" ]; then
            STATUS="âœ… ë³‘í•© ì™„ë£Œ!"
            COLOR="65280"
            EMOJI="ğŸ‰"
          else
            STATUS="âŒ PR ë‹«í˜"
            COLOR="16711680"
            EMOJI="ğŸš«"
          fi

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"embeds\": [{
                  \"title\": \"$EMOJI $STATUS\",
                  \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                  \"color\": $COLOR,
                  \"fields\": [
                    {
                      \"name\": \"ğŸ‘¤ ì‘ì„±ì\",
                      \"value\": \"${{ github.event.pull_request.user.login }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ğŸŒ¿ ë¸Œëœì¹˜\",
                      \"value\": \"\`${{ github.event.pull_request.head.ref }}\` â†’ \`${{ github.event.pull_request.base.ref }}\`\",
                      \"inline\": true
                    }
                  ]
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë¦¬ë·° ìŠ¹ì¸ ì‹œ PR ì‘ì„±ì ë©˜ì…˜
      - name: Notify on Review Approved
        if: github.event.review.state == 'approved'
        run: |
          # PR ì‘ì„±ì Discord ID ë§¤í•‘
          case "${{ github.event.pull_request.user.login }}" in
            "chen4023")
                  AUTHOR_MENTION="<@683563560063991848>"
                  ;;
            "Kwonyeojiny")
                  AUTHOR_MENTION="<@579296258091646976>"
                  ;;
            "shin-minhyuk")
                  AUTHOR_MENTION="<@1121074841102069814>"
                  ;;
            "sysysysyb")
                  AUTHOR_MENTION="<@950597490086924368>"
                  ;;
             "dirage1")
                  AUTHOR_MENTION="<@1128168230540804258>"
                  ;;
             "Jaeeun0723")
                  AUTHOR_MENTION="<@478568545748254720>"
                  ;;
             "JaeHyunLee123")
                  AUTHOR_MENTION="<@338615685498273792>"
                  ;;
            *)
              AUTHOR_MENTION="@${{ github.event.pull_request.user.login }}"
              ;;
          esac

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"content\": \"ğŸ‘ **ë¦¬ë·°ê°€ ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!** $AUTHOR_MENTION\",
                \"embeds\": [{
                  \"title\": \"âœ… ë¦¬ë·° ìŠ¹ì¸ ì™„ë£Œ!\",
                  \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                  \"color\": 65280,
                  \"fields\": [
                    {
                      \"name\": \"ğŸ‘€ ë¦¬ë·°ì–´\",
                      \"value\": \"${{ github.event.review.user.login }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ğŸ’¬ ë¦¬ë·° ë‚´ìš©\",
                      \"value\": \"ìŠ¹ì¸ë˜ì—ˆìŠµë‹ˆë‹¤!\",
                      \"inline\": false
                    }
                  ],
                  \"footer\": {
                    \"text\": \"ì´ì œ ë³‘í•©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤! ğŸš€\"
                  }
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}

      # ë³€ê²½ ì‚¬í•­ ìš”ì²­ ì•Œë¦¼
      - name: Notify on Changes Requested
        if: github.event.review.state == 'changes_requested'
        run: |
          # PR ì‘ì„±ì Discord ID ë§¤í•‘
          case "${{ github.event.pull_request.user.login }}" in
            "chen4023")
                  AUTHOR_MENTION="<@683563560063991848>"
                  ;;
            "Kwonyeojiny")
                  AUTHOR_MENTION="<@579296258091646976>"
                  ;;
            "shin-minhyuk")
                  AUTHOR_MENTION="<@1121074841102069814>"
                  ;;
            "sysysysyb")
                  AUTHOR_MENTION="<@950597490086924368>"
                  ;;
             "dirage1")
                  AUTHOR_MENTION="<@1128168230540804258>"
                  ;;
             "Jaeeun0723")
                  AUTHOR_MENTION="<@478568545748254720>"
                  ;;
             "JaeHyunLee123")
                  AUTHOR_MENTION="<@338615685498273792>"
                  ;;
              *)
		              AUTHOR_MENTION="@${{ github.event.pull_request.user.login }}"
		              ;;
          esac

          curl -H "Content-Type: application/json" \
              -X POST \
              -d "{
                \"content\": \"ğŸ”„ **ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤!** $AUTHOR_MENTION\",
                \"embeds\": [{
                  \"title\": \"â— ìˆ˜ì •ì´ í•„ìš”í•©ë‹ˆë‹¤\",
                  \"description\": \"[${{ github.event.pull_request.title }}](${{ github.event.pull_request.html_url }})\",
                  \"color\": 16776960,
                  \"fields\": [
                    {
                      \"name\": \"ğŸ‘€ ë¦¬ë·°ì–´\",
                      \"value\": \"${{ github.event.review.user.login }}\",
                      \"inline\": true
                    },
                    {
                      \"name\": \"ğŸ“ ìš”ì²­ì‚¬í•­\",
                      \"value\": \"ë³€ê²½ì‚¬í•­ì´ ìš”ì²­ë˜ì—ˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ PRì„ í™•ì¸í•´ì£¼ì„¸ìš”.\",
                      \"inline\": false
                    }
                  ]
                }]
              }" \
              ${{ secrets.DISCORD_WEBHOOK_URL }}